<!DOCTYPE html>
<html>
  <head>
    <title>ë¹ˆ í˜ì´ì§€</title>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      body {
        background-color: white;
        margin: 0;
        padding: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      form {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: #fff;
        z-index: 1000;
      }
      ul {
        list-style-type: none;
        margin: 0;
        padding: 10px;
        overflow-y: scroll;
        height: calc(100vh - 100px); /* í™”ë©´ ì „ì²´ ë†’ì´ì—ì„œ í¼ ë†’ì´ë¥¼ ëº€ ê°’ */
        box-sizing: border-box;
        box-sizing: border-box;
        padding-bottom: 50px; /* í¼ì˜ ë†’ì´ë§Œí¼ ì—¬ë°± ì¶”ê°€ */
      }
      #nosuper {
        padding: 8px;
        margin-bottom: 6px;
        background: #fef01b;
        border-radius: 20px 20px 20px 20px;
        font-size: 12px;
        width: 70%;
        margin-left: auto;
      }
      #super {
        padding: 8px;
        margin-bottom: 6px;
        background: #ffffff;
        border-radius: 20px 20px 20px 20px;
        font-size: 12px;
        width: 70%;
      }
      input {
        padding: 20px;
        width: 80%;
      }
      button {
        padding: 8px;
      }

      #key {
        display: none;
      }
    </style>

    <script>
      window.onload = function () {
        document.getElementById("key").style.display = "none";
      };

      function handleVisibilityChange() {
        if (document.hidden) {
        } else {
          //location.reload(true);
          document.getElementById("key").style.display = "none";
        }
      }

      // ì—°ì†ëœ ìˆ«ìë¥¼ ì €ì¥í•  ë³€ìˆ˜
      let currentSequence = "";

      // í‚¤ ë‹¤ìš´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      function handleKeyDown(event) {
        // ì…ë ¥ëœ í‚¤ê°€ ìˆ«ìì¸ì§€ í™•ì¸
        const key = event.key;
        console.log(key);

        if (/\d/.test(key)) {
          // ìˆ«ìê°€ ì…ë ¥ë˜ë©´ í˜„ì¬ ì‹œí€€ìŠ¤ì— ì¶”ê°€
          currentSequence += key;

          // í˜„ì¬ ì‹œí€€ìŠ¤ì˜ ê¸¸ì´ë¥¼ í™•ì¸
          if (currentSequence.length > 4) {
            // 4ìë¦¬ë¥¼ ì´ˆê³¼í•˜ë©´ ê°€ì¥ ì˜¤ë˜ëœ ìˆ«ìë¥¼ ì œê±°
            currentSequence = currentSequence.slice(-4);
          }

          // ì—°ì†ëœ 4ìë¦¬ ìˆ«ìê°€ í™•ì¸ë˜ë©´ ì²˜ë¦¬
          if (currentSequence.length === 4) {
            if (currentSequence == "8081") {
              document.body.style.backgroundColor = '#9bbbd4';
              document.getElementById("key").style.display = "block";
            }
            //console.log("Detected 4-digit sequence:", currentSequence);

            // 4ìë¦¬ ìˆ«ìë¥¼ ë°œê²¬í–ˆì„ ë•Œì˜ ì²˜ë¦¬ ë¡œì§ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            // ì˜ˆë¥¼ ë“¤ì–´, í˜ì´ì§€ë¥¼ ë¦¬ë””ë ‰ì…˜í•˜ê±°ë‚˜ ì•Œë¦¼ì„ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            //alert("4-digit sequence detected: " + currentSequence);
          }
        } else {
          // ìˆ«ìê°€ ì•„ë‹Œ í‚¤ê°€ ì…ë ¥ëœ ê²½ìš°, í˜„ì¬ ì‹œí€€ìŠ¤ ì´ˆê¸°í™”
          currentSequence = "";
        }
      }

      // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.addEventListener("keydown", handleKeyDown);
      document.addEventListener("visibilitychange", handleVisibilityChange);

      let touchCount = 0;
      const maxTouches = 10;
      const touchInterval = 1300; // 2 seconds window to count touches
      let lastTouchTime = 0;
      let timeoutId;

      document.addEventListener("touchstart", (event) => {
        const currentTime = Date.now();

        if (currentTime - lastTouchTime > touchInterval) {
          // Reset touch count if the interval exceeds the defined window
          touchCount = 0;
        }

        lastTouchTime = currentTime;
        touchCount++;

        if (touchCount >= maxTouches) {
          console.log("10 touches detected!");
          document.body.style.backgroundColor = '#9bbbd4';
          document.getElementById("key").style.display = "block";
          touchCount = 0; // Optionally reset the count after detection
        }

        // Optionally, you can clear any existing timeout to keep counting within the interval
        if (timeoutId) {
          clearTimeout(timeoutId);
        }
        timeoutId = setTimeout(() => {
          touchCount = 0; // Reset count if interval expires
        }, touchInterval);
      });
    </script>
  </head>
  <body>
    <div id="key" style="width: 100%; height: 100%">
      <button
        style="width: 100%; margin: 8px"
        type="button"
        class="btn btn-danger"
        id="clear"
      >
        clear
      </button>
      <ul id="messages"></ul>

      <form id="form" action="">
        <div class="input-group mb-3">
          <input
            type="text"
            id="input"
            class="form-control"
            placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."
            aria-label="Recipient's username"
            aria-describedby="basic-addon2" 
            autocomplete='off'
          />
          <div class="input-group-append">
            <button type="submit" class="btn btn-primary">
              ì „ì†¡
            </button>
          </div>
          <div class="input-group-append">
            <label class="btn btn-outline-secondary">
              <input type="file" id="file-input" style="display: none;" />
              ğŸ“
            </label>
          </div>
        </div>
      </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const messages = document.getElementById("messages");

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        if (input.value) {
          const queryString = window.location.search;

          const urlParams = new URLSearchParams(queryString);

          // íŠ¹ì • í‚¤ì˜ ê°’ ê°€ì ¸ì˜¤ê¸° ì˜ˆì‹œ
          // ì˜ˆë¥¼ ë“¤ì–´, URLì´ ?k=123&name=John ì¼ ë•Œ
          const kValue = urlParams.get("k"); // '123'

          if (kValue == 123) {
            socket.emit("chat message", "*" + input.value);
          } else {
            socket.emit("chat message", input.value);
          }

          input.value = "";
        }
      });

      const clearBtn = document.getElementById("clear");
      console.log(clearBtn);
      clearBtn.addEventListener("click", function (e) {
        socket.emit("clear", "");
        location.reload(true);
      });

      socket.on("chat messages", function (msgs) {
        msgs.forEach(function (msg) {
          const item = document.createElement("li");
          console.log(msg.charAt(6));
          if (msg.charAt(6) == "*") {
            msg = msg.replace("*", "");
            item.id = "super";
          } else {
            item.id = "nosuper";
          }

          item.textContent = msg;

          messages.appendChild(item);
        });
        //window.scrollTo(0, document.body.scrollHeight);
        messages.scrollTop = messages.scrollHeight; // ë§ˆì§€ë§‰ ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤
      });

      socket.on("chat message", function (msg) {
        const item = document.createElement("li");
        if (msg.charAt(6) == "*") {
          msg = msg.replace("*", "");
          item.id = "super";
        } else {
          item.id = "nosuper";
        }

        item.textContent = msg;

        messages.appendChild(item);
        //window.scrollTo(0, document.body.scrollHeight);
        messages.scrollTop = messages.scrollHeight; // ë§ˆì§€ë§‰ ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤
        document.getElementById("input").focus();
      });

      // ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œ ë  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ ë©”ì‹œì§€ë¡œ ì¶”ê°€
      socket.on('newImage', (data) => {
        const li = document.createElement("li");

        const img = document.createElement('img');
        img.src = data.imageUrl;
        img.style.maxWidth = '100%';  // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì •
        img.style.height = 'auto';    // ë¹„ìœ¨ ìœ ì§€
        li.appendChild(img);
        
        messages.appendChild(li);
        document.getElementById("input").focus();
      });

     // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì±„íŒ… ë©”ì‹œì§€ ì²˜ë¦¬
    document.getElementById('file-input').addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload', {
          method: 'POST',
          body: formData
        }).then(response => {
          if (response.ok) {
            console.log('File uploaded successfully');
          } else {
            console.error('File upload failed');
          }
        }).catch(error => {
          console.error('Error:', error);
        });
      }
    });
      
    </script>
  </body>
</html>
